"0","# RF model (workflow) từ script 06 sử dụng engine ""randomForest"""
"0","# Chúng ta cần trích xuất mô hình gốc để sử dụng varImpPlot hoặc importance()"
"0","# Hoặc sử dụng vip::vip() trực tiếp trên workflow object nếu hỗ trợ"
"0",""
"0","# Cách 1: Dùng vip (khuyến nghị cho tidymodels)"
"0","# vip_rf <- vip(model_rf_tuned, num_features = 20, geom = ""col"", aesthetics = list(fill = ""steelblue"")) +"
"0","#   labs(title = ""Độ quan trọng của Biến - Random Forest (Tuned)"","
"0","#        subtitle = ""Dựa trên Mean Decrease Gini (mặc định cho RF)"") +"
"0","#   theme_minimal()"
"0","# print(vip_rf)"
"0",""
"0","# Cách 2: Trích xuất mô hình randomForest gốc (nếu cần độ linh hoạt của randomForest::importance)"
"0","# Kiểm tra xem model_rf_tuned$fit$fit$fit là đối tượng randomForest"
"0","if (inherits(model_rf_tuned$fit$fit$fit, ""randomForest"")) {"
"0","    rf_engine_model <- model_rf_tuned$fit$fit$fit"
"0","    "
"0","    # Lấy tầm quan trọng"
"0","    rf_importance_df <- as.data.frame(importance(rf_engine_model))"
"0","    rf_importance_df$Variable <- rownames(rf_importance_df)"
"0","    rownames(rf_importance_df) <- NULL"
"0","    "
"0","    # Sắp xếp theo MeanDecreaseGini và lấy top 20"
"0","    rf_importance_top20 <- rf_importance_df %>%"
"0","      arrange(desc(MeanDecreaseGini)) %>%"
"0","      head(20)"
"0",""
"0","    vip_rf_plot <- ggplot(rf_importance_top20, aes(x = reorder(Variable, MeanDecreaseGini), y = MeanDecreaseGini)) +"
"0","      geom_col(fill = ""skyblue"") +"
"0","      coord_flip() +"
"0","      labs(title = ""Top 20 Biến Quan trọng - Random Forest (Tuned)"","
"0","           subtitle = ""Dựa trên Mean Decrease Gini"","
"0","           x = ""Biến"", y = ""Mean Decrease Gini"") +"
"0","      theme_minimal()"
"0","    print(vip_rf_plot)"
"0","    "
"0","    ggsave(paste0(RESULTS_DIR, ""feature_importance/rf_feature_importance_final.png""), plot = vip_rf_plot, width = 10, height = 8)"
"0","    cat(""Đã lưu biểu đồ độ quan trọng RF vào thư mục results/feature_importance.\n"")"
"0","} else {"
"0","    cat(""Không thể trích xuất mô hình randomForest gốc từ workflow. Sử dụng vip() nếu có thể.\n"")"
"0","    # Thử lại với vip() như một phương án dự phòng"
"0","    tryCatch({"
"0","        vip_rf_plot <- vip(model_rf_tuned, num_features = 20, geom = ""col"", aesthetics = list(fill = ""steelblue"")) +"
"0","          labs(title = ""Độ quan trọng của Biến - Random Forest (Tuned)"","
"0","               subtitle = ""Mặc định từ vip()"") +"
"0","          theme_minimal()"
"0","        print(vip_rf_plot)"
"0","        ggsave(paste0(RESULTS_DIR, ""feature_importance/rf_feature_importance_final.png""), plot = vip_rf_plot, width = 10, height = 8)"
"0","        cat(""Đã lưu biểu đồ độ quan trọng RF (từ vip) vào thư mục results/feature_importance.\n"")"
"0","    }, error = function(e) {"
"0","        cat(""Lỗi khi tạo biểu đồ vip cho RF:"", conditionMessage(e), ""\n"")"
"0","    })"
"0","}"
"1","Đã lưu biểu đồ độ quan trọng RF vào thư mục results/feature_importance.
"
